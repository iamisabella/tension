<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tension</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                align-items: flex-start;
            }
        }

        .container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 700px;
            width: 100%;
            padding: 40px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 0;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .question-header {
                margin-bottom: 20px;
                padding-bottom: 12px;
            }
        }

        .question-number {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .question-number {
                font-size: 13px;
            }
        }

        .timer {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            font-variant-numeric: tabular-nums;
            min-width: 60px;
            text-align: right;
        }

        .timer.blink {
            animation: blink 0.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .question-text {
            font-size: 18px;
            line-height: 1.6;
            color: #222;
            margin-bottom: 30px;
            white-space: pre-line;
        }

        @media (max-width: 768px) {
            .question-text {
                font-size: 16px;
                line-height: 1.5;
                margin-bottom: 20px;
            }
        }

        .question-passage {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e8e8e8;
        }

        @media (max-width: 768px) {
            .question-passage {
                margin-bottom: 12px;
                padding-bottom: 12px;
                font-size: 15px;
                line-height: 1.4;
            }
        }

        .question-statement {
            font-weight: 500;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .question-statement {
                margin-top: 12px;
                font-size: 15px;
            }
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 16px;
            background: white;
            text-align: left;
        }

        @media (max-width: 768px) {
            .option {
                padding: 18px 20px;
                font-size: 17px;
                min-height: 56px;
                display: flex;
                align-items: center;
            }
        }

        .option:hover {
            border-color: #999;
            background: #fafafa;
        }

        .option.selected {
            border-color: #333;
            background: #f0f0f0;
        }

        .results {
            text-align: center;
        }

        .results h2 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #222;
        }

        .results-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 40px;
            gap: 20px;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .stats {
                gap: 12px;
            }
        }

        .stat {
            flex: 1;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 6px;
            position: relative;
            min-width: 120px;
        }

        @media (max-width: 768px) {
            .stat {
                flex: 0 0 calc(50% - 6px);
                padding: 15px;
                min-width: 0;
            }
        }

        .stat-value {
            font-size: 36px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-baseline {
            font-size: 13px;
            color: #999;
            margin-top: 4px;
        }

        .stat-arrow {
            font-size: 24px;
            line-height: 1;
        }

        .stat-arrow.up {
            color: #22c55e;
        }

        .stat-arrow.down {
            color: #ef4444;
        }

        .stat-arrow.same {
            color: #666;
            opacity: 0.5;
        }

        .button {
            padding: 14px 32px;
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .button:hover {
            background: #555;
        }

        .start-screen {
            text-align: center;
        }

        .start-screen h1 {
            font-size: 32px;
            margin-bottom: 15px;
            color: #222;
        }

        .start-screen p {
            font-size: 18px;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .start-screen h1 {
                font-size: 28px;
            }
            
            .start-screen p {
                font-size: 16px;
                margin-bottom: 30px;
            }
        }

        #baselineDisplay {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 6px;
            font-size: 14px;
            color: #666;
        }

        @media (max-width: 768px) {
            #baselineDisplay {
                font-size: 13px;
                padding: 12px;
                line-height: 1.5;
            }
        }

        .hidden {
            display: none;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .toggle-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: #333;
            color: white;
            border-color: #333;
        }

        .toggle-btn:hover:not(.active) {
            border-color: #999;
        }

        #graphCanvas {
            width: 100%;
            height: 300px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }

        .graph-container {
            margin: 30px 0;
        }

        .reset-link {
            margin-top: 20px;
            text-align: center;
        }

        .reset-link a {
            font-size: 13px;
            color: #999;
            text-decoration: none;
            cursor: pointer;
        }

        .reset-link a:hover {
            color: #666;
            text-decoration: underline;
        }

        /* Confidence Screen */
        .confidence-screen {
            text-align: center;
        }

        .confidence-screen h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #222;
        }

        .confidence-screen p {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
        }

        .confidence-scale {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .confidence-btn {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #333;
        }

        .confidence-btn:hover {
            border-color: #999;
            background: #fafafa;
        }

        .confidence-btn.selected {
            border-color: #333;
            background: #333;
            color: white;
        }

        @media (max-width: 768px) {
            .confidence-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Start Screen -->
        <div id="startScreen" class="start-screen">
            <h1>Tension</h1>
            <p>Practice under pressure. 10 questions. 15 seconds each.</p>
            <div id="baselineDisplay"></div>
            <button class="button" onclick="startSession()">Start</button>
        </div>

        <!-- Question Screen -->
        <div id="questionScreen" class="hidden">
            <div class="question-header">
                <div class="question-number" id="questionNumber">Question 1 of 10</div>
                <div class="timer" id="timer">15</div>
            </div>
            <div class="question-text" id="questionText"></div>
            <div class="options" id="options"></div>
        </div>

        <!-- Confidence Screen -->
        <div id="confidenceScreen" class="hidden">
            <div class="confidence-screen">
                <h2>How confident did you feel?</h2>
                <p>Rate your overall confidence during this session</p>
                <div class="confidence-scale">
                    <button class="confidence-btn" onclick="selectConfidence(1)">1</button>
                    <button class="confidence-btn" onclick="selectConfidence(2)">2</button>
                    <button class="confidence-btn" onclick="selectConfidence(3)">3</button>
                    <button class="confidence-btn" onclick="selectConfidence(4)">4</button>
                    <button class="confidence-btn" onclick="selectConfidence(5)">5</button>
                    <button class="confidence-btn" onclick="selectConfidence(6)">6</button>
                    <button class="confidence-btn" onclick="selectConfidence(7)">7</button>
                    <button class="confidence-btn" onclick="selectConfidence(8)">8</button>
                    <button class="confidence-btn" onclick="selectConfidence(9)">9</button>
                    <button class="confidence-btn" onclick="selectConfidence(10)">10</button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden">
            <div class="results">
                <h2>Session Complete</h2>
                <p class="results-subtitle">Here's how you did</p>
                
                <!-- View Toggle (only shown if baseline exists) -->
                <div id="viewToggle" class="view-toggle hidden">
                    <button class="toggle-btn active" onclick="showStatsView()">This Session</button>
                    <button class="toggle-btn" onclick="showGraphView()">Progress</button>
                </div>

                <!-- Stats View -->
                <div id="statsView">
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-label">Correct</div>
                            <div class="stat-value" id="completedCount">0</div>
                            <div class="stat-baseline" id="correctBaseline"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Timeouts</div>
                            <div class="stat-value" id="timeoutCount">0</div>
                            <div class="stat-baseline" id="timeoutBaseline"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Last 3 Seconds</div>
                            <div class="stat-value" id="lastSecondCount">0</div>
                            <div class="stat-baseline" id="lastSecondBaseline"></div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Confidence</div>
                            <div class="stat-value" id="confidenceCount">0</div>
                            <div class="stat-baseline" id="confidenceBaseline"></div>
                        </div>
                    </div>
                    <div id="baselinePrompt" class="hidden" style="margin: 30px 0; padding: 20px; background: #f0f7ff; border-radius: 6px;">
                        <p style="margin-bottom: 15px; color: #333;">Save this as your baseline to track progress over time?</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button class="button" onclick="saveBaseline()" style="background: #333;">Yes, save baseline</button>
                            <button class="button" onclick="skipBaseline()" style="background: #999;">No, just practice</button>
                        </div>
                    </div>
                </div>

                <!-- Graph View -->
                <div id="graphView" class="hidden">
                    <div class="graph-container">
                        <canvas id="graphCanvas"></canvas>
                    </div>
                </div>

                <button class="button" id="goAgainButton" onclick="startSession()">Go Again</button>
                
                <div class="reset-link" id="resetLink" style="display: none;">
                    <a onclick="resetBaseline()">Reset baseline</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const questionPool = [
            // Reading comprehension with inference (15-20 sec)
            {
                text: "The destruction of the world's forests has proceeded at an alarming rate over the past two decades, mainly as a result of economic pressures in the developing world. Forests of growing trees absorb carbon dioxide, but this is released into the atmosphere when they are cut down and allowed to rot, or are burnt. The tropical rain forests, home to half the world's plant and animal species, are of special concern.",
                statement: "Countries in the developing world get much of their wood from tropical rain forests.",
                options: ["True", "False", "Can't tell"],
                correct: 2
            },
            {
                text: "Studies show that people who exercise regularly report higher levels of happiness. Regular exercise releases endorphins, which are natural mood elevators. Additionally, physical activity improves sleep quality and reduces stress.",
                statement: "Everyone who exercises will become happier.",
                options: ["True", "False", "Can't tell"],
                correct: 1
            },
            {
                text: "The company's new policy requires all employees to attend monthly training sessions. These sessions cover workplace safety, new software tools, and team collaboration techniques. Attendance is tracked and reported to department managers.",
                statement: "Employees can skip training if their manager approves it.",
                options: ["True", "False", "Can't tell"],
                correct: 2
            },
            {
                text: "Research indicates that multilingual individuals often perform better on cognitive tasks requiring attention and focus. The constant practice of switching between languages appears to strengthen executive function in the brain.",
                statement: "Learning a second language will improve your focus.",
                options: ["True", "False", "Can't tell"],
                correct: 2
            },
            {
                text: "The meeting has been moved from Tuesday to Thursday due to scheduling conflicts.",
                statement: "The meeting is still on Tuesday.",
                options: ["True", "False"],
                correct: 1
            },
            {
                text: "All employees must submit their timesheets by Friday at 5 PM. Late submissions will not be processed until the following week.",
                statement: "Timesheets submitted on Monday will be processed immediately.",
                options: ["True", "False", "Can't tell"],
                correct: 1
            },
            
            // Simple comparisons - varied types (10-12 sec)
            {
                text: "Which number is smaller?",
                options: ["1/3", "0.3"],
                correct: 1
            },
            {
                text: "Which is larger?",
                options: ["3/5", "0.7"],
                correct: 1
            },
            {
                text: "Which number is closer to 1?",
                options: ["7/8", "0.8"],
                correct: 0
            },
            {
                text: "Which represents more?",
                options: ["60%", "3/5"],
                correct: 0
            },
            
            // Pattern recognition - distinct patterns (12-15 sec)
            {
                text: "What's the next number: 1, 5, 11, 17",
                options: ["23", "21"],
                correct: 0
            },
            {
                text: "What comes next: 2, 6, 12, 20, 30",
                options: ["40", "42"],
                correct: 1
            },
            {
                text: "Complete the pattern: 3, 7, 15, 31",
                options: ["63", "47"],
                correct: 0
            },
            {
                text: "What's next: 1, 4, 9, 16, 25",
                options: ["30", "36"],
                correct: 1
            },
            {
                text: "Continue the sequence: 2, 3, 5, 8, 12",
                options: ["17", "15"],
                correct: 0
            },
            {
                text: "Next number: 5, 10, 20, 40",
                options: ["80", "60"],
                correct: 0
            },
            
            // Logic puzzles - diverse scenarios (15-18 sec)
            {
                text: "Los Angeles is twice as big as New York. New York is half as big as Florida. Florida is half as big as Connecticut. Connecticut is half as big as Los Angeles.",
                options: ["True", "False"],
                correct: 1
            },
            {
                text: "If all Bloops are Razzies and all Razzies are Lazzies, then all Bloops are definitely Lazzies.",
                options: ["True", "False"],
                correct: 0
            },
            {
                text: "All squares have four sides. This shape has four sides. Therefore, this shape is a square.",
                options: ["True", "False"],
                correct: 1
            },
            {
                text: "If no birds can swim, and penguins are birds, then penguins cannot swim.",
                options: ["True", "False"],
                correct: 0
            },
            {
                text: "Some teachers are musicians. All musicians are creative. Therefore, some teachers are creative.",
                options: ["True", "False"],
                correct: 0
            },
            
            // Math word problems - varied contexts (15-20 sec)
            {
                text: "A bat and ball cost $1.10 in total. The bat costs $1 more than the ball. How much does the ball cost?",
                options: ["$0.10", "$0.05"],
                correct: 1
            },
            {
                text: "If it takes 5 machines 5 minutes to make 5 widgets, how long would it take 100 machines to make 100 widgets?",
                options: ["100 minutes", "5 minutes"],
                correct: 1
            },
            {
                text: "In a lake, there is a patch of lily pads. Every day, the patch doubles in size. If it takes 48 days for the patch to cover the entire lake, how long would it take for the patch to cover half of the lake?",
                options: ["24 days", "47 days"],
                correct: 1
            },
            {
                text: "A book costs $8 more than a bookmark. Together they cost $10. How much does the bookmark cost?",
                options: ["$2", "$1"],
                correct: 1
            },
            {
                text: "If 3 cats can catch 3 mice in 3 minutes, how many cats are needed to catch 100 mice in 100 minutes?",
                options: ["100 cats", "3 cats"],
                correct: 1
            },
            {
                text: "A shirt is on sale for 25% off. The sale price is $30. What was the original price?",
                options: ["$40", "$37.50"],
                correct: 0
            },
            
            // Quick calculation - varied operations (10-12 sec)
            {
                text: "What is 15% of 80?",
                options: ["12", "10"],
                correct: 0
            },
            {
                text: "What is 7 × 8?",
                options: ["56", "54"],
                correct: 0
            },
            {
                text: "What is 144 ÷ 12?",
                options: ["12", "14"],
                correct: 0
            },
            {
                text: "What is 9 × 7?",
                options: ["63", "56"],
                correct: 0
            },
            {
                text: "What is 20% of 150?",
                options: ["30", "25"],
                correct: 0
            },
            
            // Probability/reasoning (15-18 sec)
            {
                text: "You flip a fair coin twice. What's the probability of getting heads both times?",
                options: ["1/2", "1/4"],
                correct: 1
            },
            {
                text: "A bag contains 3 red balls and 2 blue balls. If you pick one ball at random, what's the probability it's red?",
                options: ["3/5", "2/5"],
                correct: 0
            },
            {
                text: "You roll a standard die. What's the probability of rolling a number greater than 4?",
                options: ["1/3", "1/2"],
                correct: 0
            },
            
            // Spatial reasoning (12-15 sec)
            {
                text: "If you fold a square piece of paper in half twice, how many layers thick will it be?",
                options: ["2", "4"],
                correct: 1
            },
            {
                text: "A cube has how many edges?",
                options: ["8", "12"],
                correct: 1
            },
            {
                text: "How many faces does a rectangular prism have?",
                options: ["6", "8"],
                correct: 0
            },
            
            // Analogies (12-15 sec)
            {
                text: "Hot is to cold as up is to:",
                options: ["down", "high"],
                correct: 0
            },
            {
                text: "Teacher is to student as doctor is to:",
                options: ["patient", "nurse"],
                correct: 0
            },
            {
                text: "Pen is to write as knife is to:",
                options: ["cut", "sharp"],
                correct: 0
            },
            
            // Sets and categories (12-15 sec)
            {
                text: "Which doesn't belong: Apple, Banana, Carrot, Orange",
                options: ["Carrot", "Orange"],
                correct: 0
            },
            {
                text: "Which doesn't belong: Oak, Pine, Rose, Maple",
                options: ["Rose", "Pine"],
                correct: 0
            },
            {
                text: "Which doesn't belong: Circle, Square, Triangle, Sphere",
                options: ["Sphere", "Circle"],
                correct: 0
            },
            
            // Time/calendar reasoning (12-15 sec)
            {
                text: "If today is Wednesday, what day will it be in 10 days?",
                options: ["Saturday", "Friday"],
                correct: 0
            },
            {
                text: "A project takes 3 weeks. If it starts on Monday, what day does it end?",
                options: ["Sunday", "Monday"],
                correct: 0
            },
            {
                text: "If your meeting is in 72 hours and it's currently Monday at noon, when is the meeting?",
                options: ["Thursday noon", "Thursday midnight"],
                correct: 0
            },
            
            // Simple inference (10-12 sec)
            {
                text: "John is taller than Mary. Mary is taller than Sue. Who is shortest?",
                options: ["Sue", "Mary"],
                correct: 0
            },
            {
                text: "The red car is faster than the blue car. The blue car is faster than the green car. Which is slowest?",
                options: ["Green", "Blue"],
                correct: 0
            },
            {
                text: "Sara earns more than Tom. Tom earns more than Lisa. Who earns the most?",
                options: ["Sara", "Tom"],
                correct: 0
            }
        ];

        let currentQuestion = 0;
        let timeLeft = 15;
        let timerInterval = null;
        let selectedAnswer = null;
        let stats = {
            correct: 0,
            timeouts: 0,
            lastSecond: 0,
            confidence: null
        };
        let baseline = null;
        let sessions = [];
        let currentQuestions = []; // Selected questions for current session

        // Shuffle and select random questions
        function getRandomQuestions(pool, count) {
            const shuffled = [...pool].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        // Load baseline and sessions from localStorage on page load
        function loadBaseline() {
            const saved = localStorage.getItem('tensionBaseline');
            if (saved) {
                baseline = JSON.parse(saved);
            }
            
            const savedSessions = localStorage.getItem('tensionSessions');
            if (savedSessions) {
                sessions = JSON.parse(savedSessions);
            }
        }

        function saveBaseline() {
            const today = new Date().toISOString().split('T')[0];
            baseline = {
                correct: stats.correct,
                timeouts: stats.timeouts,
                lastSecond: stats.lastSecond,
                confidence: stats.confidence,
                date: today
            };
            
            // Also save this as first session
            sessions = [{
                correct: stats.correct,
                timeouts: stats.timeouts,
                lastSecond: stats.lastSecond,
                confidence: stats.confidence,
                date: today
            }];
            
            localStorage.setItem('tensionBaseline', JSON.stringify(baseline));
            localStorage.setItem('tensionSessions', JSON.stringify(sessions));
            
            document.getElementById('baselinePrompt').classList.add('hidden');
            showResults(); // Refresh to show comparison
        }

        function skipBaseline() {
            document.getElementById('baselinePrompt').classList.add('hidden');
        }

        function resetBaseline() {
            if (confirm('This will clear your baseline and all session history. Continue?')) {
                localStorage.removeItem('tensionBaseline');
                localStorage.removeItem('tensionSessions');
                baseline = null;
                sessions = [];
                location.reload();
            }
        }

        function showStatsView() {
            document.getElementById('statsView').classList.remove('hidden');
            document.getElementById('graphView').classList.add('hidden');
            document.querySelectorAll('.toggle-btn')[0].classList.add('active');
            document.querySelectorAll('.toggle-btn')[1].classList.remove('active');
        }

        function showGraphView() {
            document.getElementById('statsView').classList.add('hidden');
            document.getElementById('graphView').classList.remove('hidden');
            document.querySelectorAll('.toggle-btn')[0].classList.remove('active');
            document.querySelectorAll('.toggle-btn')[1].classList.add('active');
            drawGraph();
        }

        function drawGraph() {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth * 2; // For retina displays
            canvas.height = 600;
            ctx.scale(2, 2);
            
            const width = canvas.width / 2;
            const height = canvas.height / 2;
            const padding = 50;
            const graphWidth = width - padding * 2;
            const graphHeight = height - padding * 2;
            
            // Clear canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            if (sessions.length === 0) return;
            
            // Draw axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Y-axis labels (0-10)
            ctx.fillStyle = '#666';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            for (let i = 0; i <= 10; i += 2) {
                const y = height - padding - (i / 10) * graphHeight;
                ctx.fillText(i.toString(), padding - 10, y + 4);
                
                // Grid lines
                ctx.strokeStyle = '#f0f0f0';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
            }
            
            // Prepare data points
            const dataPoints = sessions.map((session, index) => ({
                x: padding + (index / Math.max(sessions.length - 1, 1)) * graphWidth,
                correct: height - padding - (session.correct / 10) * graphHeight,
                timeouts: height - padding - (session.timeouts / 10) * graphHeight,
                lastSecond: height - padding - (session.lastSecond / 10) * graphHeight,
                confidence: height - padding - (session.confidence / 10) * graphHeight,
                date: session.date
            }));
            
            // Draw lines
            function drawLine(dataKey, color, lineStyle) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                
                if (lineStyle === 'dashed') {
                    ctx.setLineDash([5, 5]);
                } else if (lineStyle === 'dotted') {
                    ctx.setLineDash([2, 3]);
                } else {
                    ctx.setLineDash([]);
                }
                
                ctx.beginPath();
                dataPoints.forEach((point, index) => {
                    if (index === 0) {
                        ctx.moveTo(point.x, point[dataKey]);
                    } else {
                        ctx.lineTo(point.x, point[dataKey]);
                    }
                });
                ctx.stroke();
                
                // Draw points
                ctx.setLineDash([]);
                dataPoints.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point[dataKey], 4, 0, Math.PI * 2);
                    ctx.fillStyle = color;
                    ctx.fill();
                });
            }
            
            drawLine('correct', '#333', 'solid');
            drawLine('timeouts', '#666', 'dashed');
            drawLine('lastSecond', '#999', 'dotted');
            drawLine('confidence', '#bbb', 'solid');
            
            // Draw legend with line labels at end of lines
            const lastPoint = dataPoints[dataPoints.length - 1];
            
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            
            // Correct
            ctx.fillStyle = '#333';
            ctx.fillText('Correct', lastPoint.x + 10, lastPoint.correct + 4);
            
            // Timeouts
            ctx.fillStyle = '#666';
            ctx.fillText('Timeouts', lastPoint.x + 10, lastPoint.timeouts + 4);
            
            // Last 3 sec
            ctx.fillStyle = '#999';
            ctx.fillText('Last 3s', lastPoint.x + 10, lastPoint.lastSecond + 4);
            
            // Confidence
            ctx.fillStyle = '#bbb';
            ctx.fillText('Confidence', lastPoint.x + 10, lastPoint.confidence + 4);
            
            // X-axis date labels (show first, middle, last)
            ctx.fillStyle = '#666';
            ctx.textAlign = 'center';
            ctx.font = '11px sans-serif';
            
            if (dataPoints.length > 0) {
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                };
                
                // First date
                ctx.fillText(formatDate(sessions[0].date), dataPoints[0].x, height - padding + 20);
                
                // Last date
                if (sessions.length > 1) {
                    ctx.fillText(formatDate(sessions[sessions.length - 1].date), 
                               dataPoints[dataPoints.length - 1].x, height - padding + 20);
                }
                
                // Middle date (if 3+ sessions)
                if (sessions.length >= 3) {
                    const midIndex = Math.floor(sessions.length / 2);
                    ctx.fillText(formatDate(sessions[midIndex].date), 
                               dataPoints[midIndex].x, height - padding + 20);
                }
            }
        }

        function startSession() {
            currentQuestion = 0;
            stats = { correct: 0, timeouts: 0, lastSecond: 0, confidence: null };
            currentQuestions = getRandomQuestions(questionPool, 10);
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('questionScreen').classList.remove('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            if (currentQuestion >= currentQuestions.length) {
                // Show confidence screen instead of results
                showConfidenceScreen();
                return;
            }

            const question = currentQuestions[currentQuestion];
            selectedAnswer = null;
            timeLeft = 15;

            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1} of ${currentQuestions.length}`;
            
            // Format question with breaks if it has a statement
            const questionContainer = document.getElementById('questionText');
            if (question.statement) {
                questionContainer.innerHTML = `
                    <div class="question-passage">${question.text}</div>
                    <div class="question-statement">Statement: ${question.statement}</div>
                `;
            } else {
                questionContainer.textContent = question.text;
            }
            
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('timer').classList.remove('blink');

            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'option';
                button.textContent = option;
                button.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(button);
            });

            startTimer();
        }

        function showConfidenceScreen() {
            clearInterval(timerInterval);
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('confidenceScreen').classList.remove('hidden');
        }

        function selectConfidence(rating) {
            stats.confidence = rating;
            
            // Visual feedback
            document.querySelectorAll('.confidence-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Save session if baseline exists
            if (baseline) {
                const today = new Date().toISOString().split('T')[0];
                sessions.push({
                    correct: stats.correct,
                    timeouts: stats.timeouts,
                    lastSecond: stats.lastSecond,
                    confidence: stats.confidence,
                    date: today
                });
                localStorage.setItem('tensionSessions', JSON.stringify(sessions));
            }
            
            // Short delay then show results
            setTimeout(() => {
                document.getElementById('confidenceScreen').classList.add('hidden');
                showResults();
            }, 300);
        }

        function selectAnswer(index) {
            selectedAnswer = index;
            
            const question = currentQuestions[currentQuestion];
            if (index === question.correct) {
                stats.correct++;
            }
            
            const timeRemaining = timeLeft;
            if (timeRemaining <= 3) {
                stats.lastSecond++;
            }

            clearInterval(timerInterval);
            
            const options = document.querySelectorAll('.option');
            options.forEach(opt => opt.classList.remove('selected'));
            options[index].classList.add('selected');

            setTimeout(() => {
                currentQuestion++;
                showQuestion();
            }, 300);
        }

        function startTimer() {
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('timer');
                timerElement.textContent = timeLeft;

                // Add blinking when 5 seconds or less
                if (timeLeft <= 5) {
                    timerElement.classList.add('blink');
                } else {
                    timerElement.classList.remove('blink');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    stats.timeouts++;
                    currentQuestion++;
                    showQuestion();
                }
            }, 1000);
        }

        function showResults() {
            clearInterval(timerInterval);
            
            document.getElementById('questionScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');

            // Helper function to get arrow and direction class
            function getArrow(current, baseline, lowerIsBetter = false) {
                if (baseline === null || baseline === undefined) return '';
                const delta = current - baseline;
                if (delta === 0) return '<span class="stat-arrow same">→</span>';
                
                if (lowerIsBetter) {
                    return delta < 0 ? '<span class="stat-arrow up">↓</span>' : '<span class="stat-arrow down">↑</span>';
                } else {
                    return delta > 0 ? '<span class="stat-arrow up">↑</span>' : '<span class="stat-arrow down">↓</span>';
                }
            }

            // Display current stats with arrows if baseline exists
            const correctArrow = baseline ? getArrow(stats.correct, baseline.correct) : '';
            const timeoutArrow = baseline ? getArrow(stats.timeouts, baseline.timeouts, true) : '';
            const lastSecondArrow = baseline ? getArrow(stats.lastSecond, baseline.lastSecond, true) : '';
            const confidenceArrow = baseline ? getArrow(stats.confidence, baseline.confidence) : '';

            document.getElementById('completedCount').innerHTML = `${stats.correct}/10 ${correctArrow}`;
            document.getElementById('timeoutCount').innerHTML = `${stats.timeouts} ${timeoutArrow}`;
            document.getElementById('lastSecondCount').innerHTML = `${stats.lastSecond} ${lastSecondArrow}`;
            document.getElementById('confidenceCount').innerHTML = `${stats.confidence}/10 ${confidenceArrow}`;

            // Display baseline text
            if (baseline) {
                document.getElementById('correctBaseline').textContent = `Baseline: ${baseline.correct}/10`;
                document.getElementById('timeoutBaseline').textContent = `Baseline: ${baseline.timeouts}`;
                document.getElementById('lastSecondBaseline').textContent = `Baseline: ${baseline.lastSecond}`;
                document.getElementById('confidenceBaseline').textContent = `Baseline: ${baseline.confidence}/10`;
            } else {
                document.getElementById('correctBaseline').textContent = '';
                document.getElementById('timeoutBaseline').textContent = '';
                document.getElementById('lastSecondBaseline').textContent = '';
                document.getElementById('confidenceBaseline').textContent = '';
            }

            // Show baseline prompt only if no baseline exists
            if (!baseline) {
                document.getElementById('baselinePrompt').classList.remove('hidden');
                document.getElementById('viewToggle').classList.add('hidden');
                document.getElementById('resetLink').style.display = 'none';
            } else {
                document.getElementById('baselinePrompt').classList.add('hidden');
                if (sessions.length >= 2) {
                    document.getElementById('viewToggle').classList.remove('hidden');
                } else {
                    document.getElementById('viewToggle').classList.add('hidden');
                }
                document.getElementById('resetLink').style.display = 'block';
            }
            
            // Make sure stats view is showing
            showStatsView();
        }

        // Initialize immediately
        loadBaseline();
        
        // Update start screen when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateStartScreen);
        } else {
            // DOM already loaded
            updateStartScreen();
        }
        
        // Fallback for Safari
        window.addEventListener('load', function() {
            if (!document.getElementById('baselineDisplay').innerHTML) {
                updateStartScreen();
            }
        });

        function updateStartScreen() {
            const display = document.getElementById('baselineDisplay');
            if (display && baseline) {
                display.innerHTML = `Your baseline: <strong>${baseline.correct}/10 correct</strong> • ${baseline.timeouts} timeouts • ${baseline.lastSecond} in last 3 seconds`;
            } else if (display) {
                display.innerHTML = 'Your baseline is stored locally on your device';
            }
        }
    </script>
</body>
</html>
